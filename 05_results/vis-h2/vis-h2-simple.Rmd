---
output: html_document
---

```{r setup, include=FALSE}
# R-Markdown Options
knitr::opts_chunk$set(echo = FALSE, cache = TRUE)
# Dependencies
library(data.table)
library(ggplot2)
dodge <- position_dodge(width = 0.8)
library(vioplot)
```

```{r variables, include=FALSE}
scale_smape <- 70
scale_mase <- 4
scale_smis <- 12

gg_violin_theme <- theme(
  plot.background = element_rect(fill = NA), 
  panel.background = element_rect(fill = NA),
  panel.border = element_blank(),
  panel.grid.major = element_line(colour = "lightgrey"), 
  panel.grid.major.y = element_blank(),
  legend.title = element_blank(), 
  legend.position = "bottom",
  legend.key = element_blank(),
  panel.spacing = unit(0.5, "lines"),
  axis.title.y = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks.y = element_blank()
)
gg_stackbar_theme <- theme(
  plot.background = element_rect(fill = NA),
  panel.background = element_rect(fill = NA),
  panel.border = element_blank(),
  panel.grid.major = element_blank(),
  axis.ticks.y = element_blank(),
  legend.position = "bottom",
  legend.key = element_blank(),
  panel.spacing = unit(0.5, "lines")
)
```

```{r data_rnn}
# RNN data
acc_ebit_h2_baselines <- readRDS("../acc_ebit_h2_rnn.rds")

acc_ebit_melt <- data.table::melt(
  acc_ebit_h2_baselines,
  id.vars = c("company", "type", "h"),
  measure.vars = c("smape", "mase", "smis"),
  variable.name = "metric",
  value.name = "accuracy"
)
acc_ebit_melt[, metric := factor(
  metric,
  levels = c("smape", "mase", "smis"),
  labels = c("sMAPE", "MASE", "sMIS")
)]
acc_ebit_melt[, type := factor(type, levels = rev(unique(type)))]

# EBIT (rank)
acc_ebit_rank_melt <- data.table::melt(
  acc_ebit_h2_baselines,
  id.vars = c("company", "type", "h"),
  measure.vars = c("rank_smape", "rank_mase", "rank_smis"),
  variable.name = "metric",
  value.name = "rank"
)
acc_ebit_rank_melt[, metric := factor(
  metric,
  levels = c("rank_smape", "rank_mase", "rank_smis"),
  labels = c("sMAPE (rk)", "MASE (rk)", "sMIS (rk)")
)]
acc_ebit_rank_melt[, type := factor(type, levels = rev(unique(type)))]
```

### (i) $H^2_C$ Accuracy Simple RNN + LSTM + GRU

#### Original
```{r accuracy}
ggplot(acc_ebit_melt, aes(x = accuracy, y = type)) +
  geom_violin(aes(group=interaction(type, h)), position = dodge) +
  geom_boxplot(aes(fill = type), width = 0.18, outlier.shape = NA, position = dodge) +
  facet_grid(h ~ metric, scales = "free") +
  scale_fill_brewer(palette = "Set1") +
  xlab(NULL) + ylab(NULL) +
  guides(fill = guide_legend(nrow = 1, reverse = TRUE)) +
  gg_violin_theme
```

#### Scaled
```{r accuracy_scaled}
ggplot(acc_ebit_melt[
  (metric == "sMAPE" & accuracy < scale_smape) | 
    (metric == "MASE" & accuracy < scale_mase) |
    (metric == "sMIS" & accuracy < scale_smis)
], aes(x = accuracy, y = type)) +
  geom_violin(aes(group=interaction(type, h)), position = dodge) +
  geom_boxplot(aes(fill = type), width = 0.18, outlier.shape = NA, position = dodge) +
  facet_grid(h ~ metric, scales = "free") +
  scale_fill_brewer(palette = "Set1") +
  xlab(NULL) + ylab(NULL) +
  guides(fill = guide_legend(nrow = 1, reverse = TRUE)) +
  gg_violin_theme
```

### (ii) $H^2_C$ Rank Simple RNN + LSTM + GRU

#### Mean of Ranks per Split
```{r mean_rank}
acc_ebit_h2_rankavg <- readRDS("../acc_ebit_h2_rnn_rankavg.rds")
acc_ebit_h2_rankavg[, type := factor(type, levels = rev(unique(type)))]

ggplot(acc_ebit_h2_rankavg, aes(x = rank_mean, y = type)) +
  geom_violin(aes(group=interaction(type, h)), position = dodge) +
  geom_boxplot(aes(fill = type), width = 0.18, outlier.shape = NA, position = dodge) +
  facet_grid(h ~ metric, scales = "free") +
  scale_fill_brewer(palette = "Set1") +
  xlab(NULL) + ylab(NULL) +
  guides(fill = guide_legend(nrow = 1, reverse = TRUE)) +
  gg_violin_theme
```

\newpage
#### Stacked Ranks Simple RNN vs. LSTM vs. GRU (only)
```{r rank_stack_01}
# Re-Factor rank and type for "correct" ordering
acc_ebit_rank_melt[, rank := factor(rank, levels = sort(unique(rank), decreasing = TRUE))]

ggplot(acc_ebit_rank_melt, aes(y = type, fill = factor(rank))) +
  geom_bar(position = "fill") +
  facet_grid(h ~ metric) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_fill_brewer(palette = "RdYlBu") +
  xlab(NULL) + ylab(NULL) + 
  guides(fill = guide_legend(title = "Rank", nrow = 1, reverse = TRUE)) +
  gg_stackbar_theme
```

#### Stacked Ranks Baselines vs. LSTM vs. GRU (incl. ARIMA, Simple, ARNN)
```{r rank_stack_02}
# Read Data
acc_ebit_01 <- readRDS("../acc_ebit_01.rds")

# EBIT (rank)
acc_ebit_01_rank_melt <- data.table::melt(
  acc_ebit_01,
  id.vars = c("company", "type", "h"),
  measure.vars = c("rank_smape", "rank_mase", "rank_smis"),
  variable.name = "metric",
  value.name = "rank"
)
acc_ebit_01_rank_melt[, metric := factor(
  metric,
  levels = c("rank_smape", "rank_mase", "rank_smis"),
  labels = c("sMAPE (rk)", "MASE (rk)", "sMIS (rk)")
)]
acc_ebit_01_rank_melt[, rank := factor(rank, levels = sort(unique(rank), decreasing = TRUE))]
acc_ebit_01_rank_melt[, type := factor(type, levels = rev(unique(type)))]

# Plot
ggplot(
  data = acc_ebit_01_rank_melt[type %in% c("Simple", "LSTM", "GRU")],
  mapping = aes(y = type, fill = factor(rank))
) +
  geom_bar(position = "fill") +
  facet_grid(h ~ metric) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_fill_brewer(palette = "RdYlBu") +
  xlab(NULL) + ylab(NULL) + 
  guides(fill = guide_legend(title = "Rank", nrow = 1, reverse = TRUE)) +
  gg_stackbar_theme
```

\newpage
### (iii) Simple RNN vs. LSTM / GRU

```{r data_single}
# Vioplot Data
acc_ebit_vioplot_lstm_rank_avg <- readRDS("../acc_ebit_h2_simple_lstm_rankavg.rds")
acc_ebit_vioplot_gru_rank_avg <- readRDS("../acc_ebit_h2_simple_gru_rankavg.rds")

# Stacked Barchart data
acc_ebit_h2_simple_lstm <- readRDS("../acc_ebit_h2_simple_lstm.rds")
acc_ebit_h2_simple_lstm_rank_melt <- data.table::melt(
  acc_ebit_h2_simple_lstm,
  id.vars = c("company", "type", "h"),
  measure.vars = c("rank_smape", "rank_mase", "rank_smis"),
  variable.name = "metric",
  value.name = "rank"
)
acc_ebit_h2_simple_lstm_rank_melt[, metric := factor(
  metric,
  levels = c("rank_smape", "rank_mase", "rank_smis"),
  labels = c("sMAPE (rk)", "MASE (rk)", "sMIS (rk)")
)]
acc_ebit_h2_simple_lstm_rank_melt[, type := factor(type, levels = rev(unique(type)))]

acc_ebit_h2_simple_gru <- readRDS("../acc_ebit_h2_simple_gru.rds")
acc_ebit_h2_simple_gru_rank_melt <- data.table::melt(
  acc_ebit_h2_simple_gru,
  id.vars = c("company", "type", "h"),
  measure.vars = c("rank_smape", "rank_mase", "rank_smis"),
  variable.name = "metric",
  value.name = "rank"
)
acc_ebit_h2_simple_gru_rank_melt[, metric := factor(
  metric,
  levels = c("rank_smape", "rank_mase", "rank_smis"),
  labels = c("sMAPE (rk)", "MASE (rk)", "sMIS (rk)")
)]
acc_ebit_h2_simple_gru_rank_melt[, type := factor(type, levels = rev(unique(type)))]
```

#### Mean Rank Simple vs. LSTM (only)
```{r accuracy_vioplot_lstm}
{
  par(mfrow = c(3, 1), mar = c(0.5, 4, 2, 1), oma = c(4, 1, 0.2, 0.2))
  for (metr in c("sMAPE (rk)", "MASE (rk)", "sMIS (rk)")) {
    vioplot(
      rank_mean ~ h, 
      data = acc_ebit_vioplot_lstm_rank_avg[type == "Simple" & metric == metr],
      col = "palevioletred", 
      plotCentre = "line",
      side = "left",
      xlab = NULL,
      ylab = metr
    )
    vioplot(
      rank_mean ~ h,
      data = acc_ebit_vioplot_lstm_rank_avg[type == "LSTM" & metric == metr],
      col = "lightblue", 
      plotCentre = "line",
      side = "right",
      add = TRUE
    )
    points(
      1:length(levels(acc_ebit_vioplot_lstm_rank_avg$h)),
      sapply(levels(acc_ebit_vioplot_lstm_rank_avg$h), function(horizon) 
        median(acc_ebit_vioplot_lstm_rank_avg[type == "Simple" & metric == metr & h == horizon, rank_mean])
      ), pch = 21, col = "palevioletred4", bg = "palevioletred2"
    )
    points(
      1:length(levels(acc_ebit_vioplot_lstm_rank_avg$h)),
      sapply(levels(acc_ebit_vioplot_lstm_rank_avg$h), function(horizon) 
        median(acc_ebit_vioplot_lstm_rank_avg[type == "LSTM" & metric == metr & h == horizon, rank_mean])
      ), pch = 21, col = "lightblue4", bg = "lightblue2"
    )
  }
  legend("bottom", fill = c("palevioletred", "lightblue"), legend = c("Simple RNN", "LSTM"), title = NULL)
  par(mfrow = c(1, 1))
}
```

#### Stacked Ranks Simple vs. LSTM (only)
```{r rank_stack_01_lstm}
# Re-Factor rank and type for "correct" ordering
acc_ebit_h2_simple_lstm_rank_melt[, rank := factor(rank, levels = sort(unique(rank), decreasing = TRUE))]

ggplot(acc_ebit_h2_simple_lstm_rank_melt, aes(y = type, fill = factor(rank))) +
  geom_bar(position = "fill") +
  facet_grid(h ~ metric) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_fill_brewer(palette = "RdYlBu") +
  xlab(NULL) + ylab(NULL) + 
  guides(fill = guide_legend(title = "Rank", nrow = 1, reverse = TRUE)) +
  gg_stackbar_theme
```

\newpage
#### Mean Rank Simple RNN vs. GRU (only)
```{r accuracy_vioplot_gru}
{
  par(mfrow = c(3, 1), mar = c(0.5, 4, 2, 1), oma = c(4, 1, 0.2, 0.2))
  for (metr in c("sMAPE (rk)", "MASE (rk)", "sMIS (rk)")) {
    vioplot(
      rank_mean ~ h, 
      data = acc_ebit_vioplot_gru_rank_avg[type == "Simple" & metric == metr],
      col = "palevioletred", 
      plotCentre = "line",
      side = "left",
      xlab = NULL,
      ylab = metr
    )
    vioplot(
      rank_mean ~ h,
      data = acc_ebit_vioplot_gru_rank_avg[type == "GRU" & metric == metr],
      col = "lightblue", 
      plotCentre = "line",
      side = "right",
      add = TRUE
    )
    points(
      1:length(levels(acc_ebit_vioplot_gru_rank_avg$h)),
      sapply(levels(acc_ebit_vioplot_gru_rank_avg$h), function(horizon) 
        median(acc_ebit_vioplot_gru_rank_avg[type == "Simple" & metric == metr & h == horizon, rank_mean])
      ), pch = 21, col = "palevioletred4", bg = "palevioletred2"
    )
    points(
      1:length(levels(acc_ebit_vioplot_gru_rank_avg$h)),
      sapply(levels(acc_ebit_vioplot_gru_rank_avg$h), function(horizon) 
        median(acc_ebit_vioplot_gru_rank_avg[type == "GRU" & metric == metr & h == horizon, rank_mean])
      ), pch = 21, col = "lightblue4", bg = "lightblue2"
    )
  }
  legend("bottom", fill = c("palevioletred", "lightblue"), legend = c("Simple RNN", "GRU"), title = NULL)
  par(mfrow = c(1, 1))
}
```

#### Stacked Ranks Simple vs. GRU (only)
```{r rank_stack_01_gru}
# Re-Factor rank and type for "correct" ordering
acc_ebit_h2_simple_gru_rank_melt[, rank := factor(rank, levels = sort(unique(rank), decreasing = TRUE))]

ggplot(acc_ebit_h2_simple_gru_rank_melt, aes(y = type, fill = factor(rank))) +
  geom_bar(position = "fill") +
  facet_grid(h ~ metric) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_fill_brewer(palette = "RdYlBu") +
  xlab(NULL) + ylab(NULL) + 
  guides(fill = guide_legend(title = "Rank", nrow = 1, reverse = TRUE)) +
  gg_stackbar_theme
```

\newpage
#### Mean Rank Simple RNN vs. LSTM (incl. Baselines, ARIMA, GRU, ARNN, RNN)
```{r data_vioplot_02}
# EBIT 02 (rank)
acc_ebit_01 <- readRDS("../acc_ebit_01.rds")
acc_ebit_01_rank_melt <- data.table::melt(
  acc_ebit_01,
  id.vars = c("company", "type", "h"),
  measure.vars = c("rank_smape", "rank_mase", "rank_smis"),
  variable.name = "metric",
  value.name = "rank"
)
acc_ebit_01_rank_melt[, metric := factor(
  metric,
  levels = c("rank_smape", "rank_mase", "rank_smis"),
  labels = c("sMAPE (rk)", "MASE (rk)", "sMIS (rk)")
)]
# EBIT 02 (rank) Average
acc_ebit_01_rank_avg <- acc_ebit_01_rank_melt[
  , .(rank_mean = mean(rank), rank_median = median(rank)), 
  by = c("company", "type", "h", "metric")
]
```

```{r accuracy_vioplot_02_lstm}
{
  par(mfrow = c(3, 1), mar = c(0.5, 4, 2, 1), oma = c(4, 1, 0.2, 0.2))
  for (metr in c("sMAPE (rk)", "MASE (rk)", "sMIS (rk)")) {
    vioplot(
      rank_mean ~ h, 
      data = acc_ebit_01_rank_avg[type == "Simple" & metric == metr],
      col = "palevioletred", 
      plotCentre = "line",
      side = "left",
      xlab = NULL, 
      ylab = metr
    )
    vioplot(
      rank_mean ~ h, 
      data = acc_ebit_01_rank_avg[type == "LSTM" & metric == metr],
      col = "lightblue", 
      plotCentre = "line",
      side = "right",
      add = TRUE
    )
    points(
      1:length(levels(acc_ebit_01_rank_avg$h)),
      sapply(levels(acc_ebit_01_rank_avg$h), function(horizon) 
        median(acc_ebit_01_rank_avg[type == "Simple" & metric == metr & h == horizon, rank_mean])
      ), pch = 21, col = "palevioletred4", bg = "palevioletred2"
    )
    points(
      1:length(levels(acc_ebit_01_rank_avg$h)),
      sapply(levels(acc_ebit_01_rank_avg$h), function(horizon) 
        median(acc_ebit_01_rank_avg[type == "LSTM" & metric == metr & h == horizon, rank_mean])
      ), pch = 21, col = "lightblue4", bg = "lightblue2"
    )
  }
  legend("bottom", fill = c("palevioletred", "lightblue"), legend = c("Simple RNN", "LSTM"), title = NULL)
  par(mfrow = c(1, 1))
}
```

#### Mean Rank Simple RNN vs. GRU (incl. Baselines, ARIMA, LSTM, ARNN, RNN)
```{r accuracy_vioplot_02_gru}
{
  par(mfrow = c(3, 1), mar = c(0.5, 4, 2, 1), oma = c(4, 1, 0.2, 0.2))
  for (metr in c("sMAPE (rk)", "MASE (rk)", "sMIS (rk)")) {
    vioplot(
      rank_mean ~ h, 
      data = acc_ebit_01_rank_avg[type == "Simple" & metric == metr],
      col = "palevioletred", 
      plotCentre = "line",
      side = "left",
      xlab = NULL, 
      ylab = metr
    )
    vioplot(
      rank_mean ~ h, 
      data = acc_ebit_01_rank_avg[type == "GRU" & metric == metr],
      col = "lightblue", 
      plotCentre = "line",
      side = "right",
      add = TRUE
    )
    points(
      1:length(levels(acc_ebit_01_rank_avg$h)),
      sapply(levels(acc_ebit_01_rank_avg$h), function(horizon) 
        median(acc_ebit_01_rank_avg[type == "Simple" & metric == metr & h == horizon, rank_mean])
      ), pch = 21, col = "palevioletred4", bg = "palevioletred2"
    )
    points(
      1:length(levels(acc_ebit_01_rank_avg$h)),
      sapply(levels(acc_ebit_01_rank_avg$h), function(horizon) 
        median(acc_ebit_01_rank_avg[type == "GRU" & metric == metr & h == horizon, rank_mean])
      ), pch = 21, col = "lightblue4", bg = "lightblue2"
    )
  }
  legend("bottom", fill = c("palevioletred", "lightblue"), legend = c("Simple RNN", "GRU"), title = NULL)
  par(mfrow = c(1, 1))
}
```
